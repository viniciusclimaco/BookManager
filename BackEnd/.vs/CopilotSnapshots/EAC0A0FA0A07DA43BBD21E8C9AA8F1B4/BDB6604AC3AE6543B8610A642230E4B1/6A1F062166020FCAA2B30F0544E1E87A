using BookManager.Infrastructure.Repositories.Interfaces;
using Microsoft.AspNetCore.Mvc;
using System.Text;
using System.Collections;

namespace BookManager.API.Controllers;

/// <summary>
/// Controller responsável pela geração de relatórios em diferentes formatos
/// Implementa geração simples em CSV para compatibilidade com .NET6
/// </summary>
[ApiController]
[Route("api/[controller]")]
public class RelatoriosController : ControllerBase
{
    private readonly IRelatorioRepository _relatorioRepository;
    private readonly IWebHostEnvironment _environment;
    private readonly ILogger<RelatoriosController> _logger;

    public RelatoriosController(
        IRelatorioRepository relatorioRepository,
        IWebHostEnvironment environment,
        ILogger<RelatoriosController> logger)
    {
        _relatorioRepository = relatorioRepository;
        _environment = environment;
        _logger = logger;
    }

    /// <summary>
    /// Gera relatório de livros agrupados por assunto
    /// </summary>
    /// <param name="formato">Formato do arquivo: PDF, EXCEL ou WORD (padrão: PDF)</param>
    /// <param name="idAssunto">ID do assunto para filtrar (opcional)</param>
    /// <param name="anoInicio">Ano inicial de publicação (opcional)</param>
    /// <param name="anoFim">Ano final de publicação (opcional)</param>
    /// <param name="apenasAtivos">Retornar apenas livros ativos (padrão: true)</param>
    /// <returns>Arquivo do relatório no formato especificado</returns>
    [HttpGet("livros-por-assunto")]
    [ProducesResponseType(typeof(FileContentResult), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status500InternalServerError)]
    public async Task<IActionResult> GerarRelatorioLivrosPorAssunto(
        [FromQuery] string formato = "CSV",
        [FromQuery] int? idAssunto = null,
        [FromQuery] int? anoInicio = null,
        [FromQuery] int? anoFim = null,
        [FromQuery] bool? apenasAtivos = true)
    {
        try
        {
            _logger.LogInformation("Gerando relatório de livros por assunto - Formato: {Formato}", formato);

            var dados = await _relatorioRepository.ObterLivrosPorAssuntoAsync(
                idAssunto, anoInicio, anoFim, apenasAtivos);

            var resultado = GerarRelatorioCsv(dados, "LivrosPorAssunto", formato);

            return File(resultado.Bytes, resultado.MimeType, resultado.NomeArquivo);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao gerar relatório de livros por assunto");
            return StatusCode(500, new { message = $"Erro ao gerar relatório: {ex.Message}" });
        }
    }

    /// <summary>
    /// Gera relatório de autores com seus livros
    /// </summary>
    /// <param name="formato">Formato do arquivo: PDF, EXCEL ou WORD (padrão: PDF)</param>
    /// <param name="idAutor">ID do autor para filtrar (opcional)</param>
    /// <returns>Arquivo do relatório no formato especificado</returns>
    [HttpGet("autores-por-livro")]
    [ProducesResponseType(typeof(FileContentResult), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status500InternalServerError)]
    public async Task<IActionResult> GerarRelatorioAutoresPorLivro(
        [FromQuery] string formato = "CSV",
        [FromQuery] int? idAutor = null)
    {
        try
        {
            _logger.LogInformation("Gerando relatório de autores por livro - Formato: {Formato}", formato);

            var dados = await _relatorioRepository.ObterAutoresPorLivroAsync(idAutor);

            var resultado = GerarRelatorioCsv(dados, "AutoresPorLivro", formato);

            return File(resultado.Bytes, resultado.MimeType, resultado.NomeArquivo);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao gerar relatório de autores por livro");
            return StatusCode(500, new { message = $"Erro ao gerar relatório: {ex.Message}" });
        }
    }

    /// <summary>
    /// Gera relatório de livros com preços por forma de pagamento
    /// </summary>
    /// <param name="formato">Formato do arquivo: PDF, EXCEL ou WORD (padrão: PDF)</param>
    /// <param name="valorMinimo">Valor mínimo para filtrar (opcional)</param>
    /// <param name="valorMaximo">Valor máximo para filtrar (opcional)</param>
    /// <param name="idFormaPagamento">ID da forma de pagamento para filtrar (opcional)</param>
    /// <param name="apenasAtivos">Retornar apenas livros ativos (padrão: true)</param>
    /// <returns>Arquivo do relatório no formato especificado</returns>
    [HttpGet("livros-com-preco")]
    [ProducesResponseType(typeof(FileContentResult), StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status500InternalServerError)]
    public async Task<IActionResult> GerarRelatorioLivrosComPreco(
        [FromQuery] string formato = "CSV",
        [FromQuery] decimal? valorMinimo = null,
        [FromQuery] decimal? valorMaximo = null,
        [FromQuery] int? idFormaPagamento = null,
        [FromQuery] bool? apenasAtivos = true)
    {
        try
        {
            _logger.LogInformation("Gerando relatório de livros com preço - Formato: {Formato}", formato);

            var dados = await _relatorioRepository.ObterLivrosComPrecoAsync(
                valorMinimo, valorMaximo, idFormaPagamento, apenasAtivos);

            var resultado = GerarRelatorioCsv(dados, "LivrosComPreco", formato);

            return File(resultado.Bytes, resultado.MimeType, resultado.NomeArquivo);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao gerar relatório de livros com preço");
            return StatusCode(500, new { message = $"Erro ao gerar relatório: {ex.Message}" });
        }
    }

    /// <summary>
    /// Método privado para geração do relatório em formato CSV
    /// </summary>
    private RelatorioResultado GerarRelatorioCsv(object dados, string baseNomeArquivo, string formato)
    {
        if (dados is not IEnumerable enumerable)
            throw new ArgumentException("Dados para relatório devem ser uma coleção.", nameof(dados));

        var sb = new StringBuilder();
        bool headerWritten = false;

        foreach (var item in enumerable)
        {
            if (item == null) continue;

            var props = item.GetType().GetProperties(System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.Public);

            if (!headerWritten)
            {
                sb.AppendLine(string.Join(',', props.Select(p => EscapeCsv(p.Name))));
                headerWritten = true;
            }

            var values = props.Select(p => {
                var val = p.GetValue(item);
                return EscapeCsv(val?.ToString() ?? string.Empty);
            });

            sb.AppendLine(string.Join(',', values));
        }

        var bytes = Encoding.UTF8.GetBytes(sb.ToString());
        var mimeType = "text/csv";
        var fileName = $"{baseNomeArquivo}_{DateTime.Now:yyyyMMddHHmmss}.csv";

        _logger.LogInformation("Relatório gerado em CSV: {FileName}", fileName);

        return new RelatorioResultado
        {
            Bytes = bytes,
            MimeType = mimeType,
            NomeArquivo = fileName
        };

        static string EscapeCsv(string s)
        {
            if (s.Contains('"') || s.Contains(',') || s.Contains('\n') || s.Contains('\r'))
            {
                return '"' + s.Replace("\"", "\"\"") + '"';
            }
            return s;
        }
    }
}

/// <summary>
/// Classe auxiliar para resultado da geração de relatório
/// </summary>
public class RelatorioResultado
{
    public byte[] Bytes { get; set; } = Array.Empty<byte>();
    public string MimeType { get; set; } = string.Empty;
    public string NomeArquivo { get; set; } = string.Empty;
}
